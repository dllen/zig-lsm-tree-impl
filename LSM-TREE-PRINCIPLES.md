# LSM Tree 原理与数据结构

## 1. 概述

LSM Tree (Log-Structured Merge Tree) 是一种用于大规模数据存储的数据结构，它通过将随机写入转换为顺序写入来提高写入性能。LSM Tree 的核心思想是将数据分层存储，新数据首先写入内存，然后定期合并并刷新到磁盘。

## 2. 核心组件

### 2.1 MemTable（内存表）

MemTable 是 LSM Tree 的内存组件，通常使用跳表（Skip List）实现：

- 特点：有序存储、快速查找（O(log n)）
- 作用：缓存最新写入的数据
- 实现：通常采用跳表数据结构
- 大小限制：到达阈值后触发刷盘

### 2.2 SSTable（静态排序表）

SSTable 是磁盘上的有序数据文件：

- 文件格式：
  - 数据区：按键排序的键值对
  - 索引区：键到文件偏移量的映射
  - 布隆过滤器：快速判断键是否存在
- 特点：
  - 不可变（Immutable）
  - 有序存储
  - 支持二分查找

### 2.3 WAL（预写日志）

WAL 用于保证数据持久性：

- 作用：防止内存数据丢失
- 格式：顺序追加的日志记录
- 恢复：系统崩溃后用于重建 MemTable

## 3. 核心操作

### 3.1 写入流程

1. 写入 WAL 日志
2. 更新 MemTable
3. MemTable 满后转换为 SSTable
4. 后台进行文件合并（Compaction）

### 3.2 读取流程

1. 查询 MemTable
2. 如未找到，按新旧顺序查询 SSTable
3. 使用布隆过滤器优化查找

### 3.3 Compaction（合并）

合并策略通常分为：

- Size-tiered：基于大小的合并
  - 相似大小的文件组合并
  - 适合写入密集场景

- Leveled：分层合并
  - 数据按层次组织
  - 每层容量递增
  - 适合读取密集场景

## 4. 性能特征

### 4.1 优点

- 写入性能优秀（顺序写）
- 读取性能可预测
- 空间放大可控

### 4.2 缺点

- 读取可能需要多次 I/O
- 需要合并开销
- 内存占用相对较高

## 5. 应用场景

- 时序数据库
- KV 存储系统
- 日志系统
- 分布式存储系统

## 6. 实现注意事项

- 合理设置 MemTable 大小
- 选择合适的合并策略
- 优化布隆过滤器参数
- 实现高效的压缩算法
- 考虑并发控制机制

## 7. 总结

LSM Tree 通过巧妙的分层设计和后台合并机制，实现了高效的写入性能，同时保持了可接受的读取性能。它的设计思想和实现方式对于构建大规模存储系统具有重要的参考价值。